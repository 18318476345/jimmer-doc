---
sidebar_position: 2
title: DraftHandler 
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

Since the functionality of `DraftHandler` and [DraftInterceptor](./draft-interceptor) is basically the same and highly similar, this article does not intend to fully repeat the explanation, but only explains the differences between them.  

## Define Handler

The handler needs to implement the `org.babyfish.jimmer.sql.DraftHandler` interface.

If using Spring to manage *(two ways of using `DraftHandler` will be introduced below)*, use `@Component` to decorate the handler implementation class, the code is as follows:  

<Tabs groupId="language">
<TabItem value="java" label="Java">  

```java  
@Component
public class BaseEntityDraftHandler implements DraftHandler<BaseEntityDraft, BaseEntity> {

    @Override
    public void beforeSave(BaseEntityDraft draft, @Nullable BaseEntity original) {
        if (original == null) {
            ...omited logic before insert...  
        } else {
            ...omited logic before update...   
        }
    }

    @Override 
    public Collection<TypedProp<E, ?>> dependencies() {
        return Arrays.asList(
            BaseEntityProps.CREATTED_BY,
            BaseEntityProps.MODIFIED_BY  
        );
    }
}  
```  

</TabItem>
<TabItem value="kotlin" label="Kotlin">  

```kotlin  
@Component
class BaseEntityDraftHandler: DraftHandler<BaseEntityDraft, BaseEntity> {

    override fun beforeSave(draft: BaseEntityDraft, original: BaseEntity?) {
        if (original == null) {
            ...omited logic before insert...
        } else {
            ...omited logic before update... 
        }
    }

    override dependencies(): Collection<TypedProp<BaseEntity, *>> = 
        listOf(
            BaseEntityProps.CREATED_BY,  
            BaseEntityProps.MODIFIED_BY
        )
}
```  

</TabItem>
</Tabs>

-   `beforeSave` method:
  
    In which, the `beforeSave` method is called before an object is saved. Users can make final adjustments to the data to be saved `draft`. This method has two parameters:

    -   `draft`: The object to be saved, you can modify it  
    
    -   `original`: If non-null, it represents the existing data in the database, which can only be read, not modified

        -   For INSERT operations, `original` is null
    
        -   For UPDATE operations, `original` is non-null  

    So you can determine whether the current operation is INSERT or UPDATE by whether `orginal` is null.
  
    The `orginal` object is a Jimmer dynamic object. Which properties are ready to access and which are missing depends on another method `dependencies`.
  
-   `dependencies` method:  

    When the `original` parameter of the `beforeSave` method is non-null, in addition to the id attribute and key attribute, which other attributes need to be loaded?  
  
    >   The returned attribute collection does not need to contain the id attribute and key attribute, because they are always loaded.  
  
    :::warning 
    Please do not modify the attributes decorated with `@Id` or `@Key` of the `draft` object in the `beforeSave` method.
    :::
  
## Usage  

### Use Jimmer Spring Starter  

In the above, the defined class `BaseEntityDraftHandler` is decorated with `@Component`, which is obviously a Spring-managed object.  

:::info  
If using the Jimmer SpringBoot Starter and ensuring that the handler is Spring-managed, Jimmer will register it automatically without additional configuration.   
Otherwise, manual registration is required.  
:::  

### Without Using Jimmer Spring Starter  

When not using the Jimmer SpringBoot Starter, attach the handler to the SqlClinet object to take effect:

<Tabs groupId="language">
<TabItem value="java" label="Java">   

```java   
@Bean
public JSqlClient sqlClient(
    List<DraftHandler<?, ?>> handlers,
    ...other parameters omitted...  
) {
    return JSqlClient  
        .newBuilder()
        // highlight-next-line 
        .addDraftHanders(handlers)
        ...other configurations omitted...
        .build();
}
```   

</TabItem>
<TabItem value="kotlin" label="Kotlin">  

```kotlin
@Bean   
fun sqlClient(
    handlers: List<DraftHandler<?, ?>>,
    ...other parameters omitted...    
): KSqlClient = newKSqlClient {
    // highlight-next-line
    addDraftHanders(handlers) 
    ...other configurations omitted...     
} 
```

</TabItem>
</Tabs>  

:::tip   
Although only one `DraftHandler` is demonstrated in this article, there may be many in an actual project.   
So, a collection is used here to allow Spring to inject all `DraftHandlers`.  
:::