"use strict";(self.webpackChunkdocusaurus_code=self.webpackChunkdocusaurus_code||[]).push([[8232],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>u});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),c=p(n),u=o,h=c["".concat(s,".").concat(u)]||c[u]||m[u]||r;return n?a.createElement(h,i(i({ref:t},d),{},{components:n})):a.createElement(h,i({ref:t},d))}));function u(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var p=2;p<r;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},85162:(e,t,n)=>{n.d(t,{Z:()=>i});var a=n(67294),o=n(34334);const r="tabItem_Ymn6";function i(e){let{children:t,hidden:n,className:i}=e;return a.createElement("div",{role:"tabpanel",className:(0,o.Z)(r,i),hidden:n},t)}},65488:(e,t,n)=>{n.d(t,{Z:()=>u});var a=n(83117),o=n(67294),r=n(34334),i=n(72389),l=n(67392),s=n(7094),p=n(12466);const d="tabList__CuJ",m="tabItem_LNqP";function c(e){var t;const{lazy:n,block:i,defaultValue:c,values:u,groupId:h,className:k}=e,N=o.Children.map(e.children,(e=>{if((0,o.isValidElement)(e)&&"value"in e.props)return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})),b=u??N.map((e=>{let{props:{value:t,label:n,attributes:a}}=e;return{value:t,label:n,attributes:a}})),g=(0,l.l)(b,((e,t)=>e.value===t.value));if(g.length>0)throw new Error(`Docusaurus error: Duplicate values "${g.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`);const f=null===c?c:c??(null==(t=N.find((e=>e.props.default)))?void 0:t.props.value)??N[0].props.value;if(null!==f&&!b.some((e=>e.value===f)))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${f}" but none of its children has the corresponding value. Available values are: ${b.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);const{tabGroupChoices:v,setTabGroupChoices:y}=(0,s.U)(),[T,C]=(0,o.useState)(f),j=[],{blockElementScrollPositionUntilNextRender:w}=(0,p.o5)();if(null!=h){const e=v[h];null!=e&&e!==T&&b.some((t=>t.value===e))&&C(e)}const E=e=>{const t=e.currentTarget,n=j.indexOf(t),a=b[n].value;a!==T&&(w(t),C(a),null!=h&&y(h,String(a)))},O=e=>{var t;let n=null;switch(e.key){case"ArrowRight":{const t=j.indexOf(e.currentTarget)+1;n=j[t]??j[0];break}case"ArrowLeft":{const t=j.indexOf(e.currentTarget)-1;n=j[t]??j[j.length-1];break}}null==(t=n)||t.focus()};return o.createElement("div",{className:(0,r.Z)("tabs-container",d)},o.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.Z)("tabs",{"tabs--block":i},k)},b.map((e=>{let{value:t,label:n,attributes:i}=e;return o.createElement("li",(0,a.Z)({role:"tab",tabIndex:T===t?0:-1,"aria-selected":T===t,key:t,ref:e=>j.push(e),onKeyDown:O,onFocus:E,onClick:E},i,{className:(0,r.Z)("tabs__item",m,null==i?void 0:i.className,{"tabs__item--active":T===t})}),n??t)}))),n?(0,o.cloneElement)(N.filter((e=>e.props.value===T))[0],{className:"margin-top--md"}):o.createElement("div",{className:"margin-top--md"},N.map(((e,t)=>(0,o.cloneElement)(e,{key:t,hidden:e.props.value!==T})))))}function u(e){const t=(0,i.Z)();return o.createElement(c,(0,a.Z)({key:String(t)},e))}},25705:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>s,default:()=>u,frontMatter:()=>l,metadata:()=>p,toc:()=>m});var a=n(83117),o=(n(67294),n(3905)),r=n(65488),i=n(85162);const l={sidebar_position:2,title:"Owner side"},s=void 0,p={unversionedId:"mutation/save-command/association/owner",id:"mutation/save-command/association/owner",title:"Owner side",description:"Basic Concepts",source:"@site/docs/mutation/save-command/association/owner.mdx",sourceDirName:"mutation/save-command/association",slug:"/mutation/save-command/association/owner",permalink:"/jimmer-doc/docs/mutation/save-command/association/owner",draft:!1,editUrl:"https://github.com/babyfish-ct/jimmer-doc/edit/main/docs/mutation/save-command/association/owner.mdx",tags:[],version:"current",lastUpdatedAt:1732491163,formattedLastUpdatedAt:"Nov 24, 2024",sidebarPosition:2,frontMatter:{sidebar_position:2,title:"Owner side"},sidebar:"tutorialSidebar",previous:{title:"Association classification",permalink:"/jimmer-doc/docs/mutation/save-command/association/classification"},next:{title:"Save Mode of Associated Objects",permalink:"/jimmer-doc/docs/mutation/save-command/associated-save-mode"}},d={},m=[{value:"Basic Concepts",id:"basic-concepts",level:2},{value:"1. Automatically Setting Reverse Associations for Child Objects",id:"1-automatically-setting-reverse-associations-for-child-objects",level:2},{value:"2. Configuring Whether Different Parent Objects Can Snatch for Child Objects",id:"2-configuring-whether-different-parent-objects-can-snatch-for-child-objects",level:2},{value:"Conservative Default Behavior",id:"conservative-default-behavior",level:3},{value:"Overriding Default Behavior Without Restrictions",id:"overriding-default-behavior-without-restrictions",level:3}],c={toc:m};function u(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"basic-concepts"},"Basic Concepts"),(0,o.kt)("p",null,"The owned side only has ",(0,o.kt)("inlineCode",{parentName:"p"},"@OneToMany")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"@OneToOne")," objects with ",(0,o.kt)("inlineCode",{parentName:"p"},"mappedBy"),". Taking ",(0,o.kt)("inlineCode",{parentName:"p"},"@OneToMany")," as an example:"),(0,o.kt)(r.Z,{groupId:"language",mdxType:"Tabs"},(0,o.kt)(i.Z,{value:"java",label:"Java",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"@Entity\npublic interface BookStore {\n\n    // highlight-next-line\n    @OneToMany(mappedBy = true)\n    List<Book> books();\n}\n"))),(0,o.kt)(i.Z,{value:"kotlin",label:"Kotlin",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-kotlin"},"@Entity\ninterface BookStore {\n\n    // highlight-next-line\n    @OneToMany(mappedBy = true)\n    val books: List<Book>\n}\n")))),(0,o.kt)("p",null,"This association has a special functionality:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Automatically sets reverse associations for child objects")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Configures whether different parent objects can snatch for child objects"))),(0,o.kt)("h2",{id:"1-automatically-setting-reverse-associations-for-child-objects"},"1. Automatically Setting Reverse Associations for Child Objects"),(0,o.kt)("p",null,"Assume we have the following entity:"),(0,o.kt)(r.Z,{groupId:"language",mdxType:"Tabs"},(0,o.kt)(i.Z,{value:"java",label:"Java",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="TreeNode.java"',title:'"TreeNode.java"'},'@Entity\npublic interface TreeNode {\n\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    long id();\n\n    // highlight-next-line\n    @Key\n    String name();\n\n    // highlight-next-line\n    @Key\n    @ManyToOne\n    @Nullable\n    TreeNode parent();\n\n    @OneToMany(mappedBy = "parent")\n    List<TreeNode> childNodes();\n}\n'))),(0,o.kt)(i.Z,{value:"kotlin",label:"Kotlin",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-kotlin",metastring:'title="TreeNode.kt"',title:'"TreeNode.kt"'},'@Entity\ninterface TreeNode {\n\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    val id: Long\n\n    // highlight-next-line\n    @Key\n    val name: String\n\n    // highlight-next-line\n    @Key\n    @ManyToOne\n    val parent: TreeNode?\n\n    @OneToMany(mappedBy = "parent")\n    val childNodes: List<TreeNode>\n}\n')))),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"@Key")," properties of ",(0,o.kt)("inlineCode",{parentName:"p"},"TreeNode")," are ",(0,o.kt)("inlineCode",{parentName:"p"},"name")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"parent"),". Apart from explicitly accepting the persistence mode for wild objects, the object being saved needs to either:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Specify the ",(0,o.kt)("inlineCode",{parentName:"p"},"TreeNode.id")," property")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"Specify both ",(0,o.kt)("inlineCode",{parentName:"p"},"TreeNode.name")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"TreeNode.parent")," properties"))),(0,o.kt)("p",null,"However, the following code works normally:"),(0,o.kt)(r.Z,{groupId:"language",mdxType:"Tabs"},(0,o.kt)(i.Z,{value:"java",label:"Java",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'TreeNode rootNode = Immutables.createTreeNode(root -> {\n    root.setName("Root");\n    root.setParent(null);\n    root.addIntoChildNodes(child -> {\n        child.setName("Child-1");\n        // For non-root objects, no need to specify the `parent` property\n    });\n    root.addIntoChildNodes(child -> {\n        child.setName("Child-2");\n        // For non-root objects, no need to specify the `parent` property\n    });\n});\nsqlClient\n    .saveCommand(rootNode)\n    .setTargetTransferModeAll(TargetTransferMode.ALLOWED)\n    .execute();\n'))),(0,o.kt)(i.Z,{value:"kotlin",label:"Kotlin",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-kotlin"},'val rootNode = TreeNode {\n    name = "Root"\n    parent = null\n    childNodes().addBy {\n        name = "Child-1"\n        // For non-root objects, \n        // no need to specify the `parent` property\n    }\n    childNodes().addBy {\n        name = "Child-2"\n        // For non-root objects, \n        // no need to specify the `parent` property\n    }\n}\nsqlClient.save(rootNode) {\n    setTargetTransferModeAll(TargetTransferMode.ALLOWED)\n}\n')))),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"setTargetTransferModeAll(TargetTransferMode.ALLOWED)")," is not the focus here, readers can ignore it for now."),(0,o.kt)("p",null,"Here, although the root object ",(0,o.kt)("em",{parentName:"p"},"(",(0,o.kt)("inlineCode",{parentName:"em"},"Root"),")")," has both ",(0,o.kt)("inlineCode",{parentName:"p"},"name")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"parent")," properties specified,\nfor non-root objects ",(0,o.kt)("em",{parentName:"p"},"(",(0,o.kt)("inlineCode",{parentName:"em"},"Child-1"),", ",(0,o.kt)("inlineCode",{parentName:"em"},"Child-2"),")"),", only the ",(0,o.kt)("inlineCode",{parentName:"p"},"name")," property is specified, while the ",(0,o.kt)("inlineCode",{parentName:"p"},"parent")," property is not."),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"TreeNode.childNodes")," property is the reverse association of the ",(0,o.kt)("inlineCode",{parentName:"p"},"TreeNode.parent")," property."),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"For the owning side of many-to-one ",(0,o.kt)("em",{parentName:"p"},"(or one-to-one)")," associations ",(0,o.kt)("em",{parentName:"p"},"(here ",(0,o.kt)("inlineCode",{parentName:"em"},"TreeNode.parent"),")"),",\nonce child objects are specified for the parent object through its inverse one-to-many ",(0,o.kt)("em",{parentName:"p"},"(or one-to-one)")," association ",(0,o.kt)("em",{parentName:"p"},"(here ",(0,o.kt)("inlineCode",{parentName:"em"},"TreeNode.childNodes"),")"),",\nthe parent object reference for each child object in the collection will be automatically set.")),(0,o.kt)("p",null,"In this example, the object tree that the user originally expected to save was:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "name":"Root",\n    "parent":null,\n    "childNodes":[\n        {"name":"Child-1"},\n        {"name":"Child-2"}\n    ]\n}\n')),(0,o.kt)("p",null,"Assuming the database assigns auto-number 100 to the root element after insertion, Jimmer will automatically adjust this tree to:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "id": 100,\n    "name":"Root",\n    "parent":null,\n    "childNodes":[\n        {\n            "name":"Child-1",\n            // highlight-next-line\n            "parent": {"id": 100}\n        },\n        {\n            "name":"Child-2",\n            // highlight-next-line\n            "parent": {"id": 100}\n        }\n    ]\n}\n')),(0,o.kt)("p",null,"As you can see, once the parent object is saved, the ",(0,o.kt)("inlineCode",{parentName:"p"},"TreeNode.parent")," property of all child objects will be automatically set. That is, when the ",(0,o.kt)("inlineCode",{parentName:"p"},"id")," property is not specified:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"From Jimmer's perspective, both ",(0,o.kt)("inlineCode",{parentName:"p"},"name")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"parent")," properties of all ",(0,o.kt)("inlineCode",{parentName:"p"},"TreeNode")," objects are specified, meaning all ",(0,o.kt)("inlineCode",{parentName:"p"},"@Key")," properties are specified")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"From the user's perspective, only the root object needs to specify both ",(0,o.kt)("inlineCode",{parentName:"p"},"name")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"parent")," properties, while all other objects only need to specify the ",(0,o.kt)("inlineCode",{parentName:"p"},"name")," property"))),(0,o.kt)("p",null,"The above example will generate three SQL statements:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Query whether the root object exists based on ",(0,o.kt)("inlineCode",{parentName:"p"},"@Key"),":"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"Purpose: COMMAND(NULL_NOT_DISTINCT_REQUIRED)\nselect\n    tb_1_.NODE_ID,\n    tb_1_.NAME,\n    tb_1_.PARENT_ID\nfrom TREE_NODE tb_1_\nwhere\n        tb_1_.PARENT_ID is null\n    and\n        tb_1_.NAME = ? /* Root */\n")),(0,o.kt)("p",{parentName:"li"},"Here, the database's own ",(0,o.kt)("inlineCode",{parentName:"p"},"UPSERT")," capability is not used, instead an additional query is made to determine whether the subsequent operation should be ",(0,o.kt)("inlineCode",{parentName:"p"},"INSERT")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"UPDATE"),"."),(0,o.kt)("p",{parentName:"li"},"This is because the database's own ",(0,o.kt)("inlineCode",{parentName:"p"},"UPSERT")," capability relies on unique constraints ",(0,o.kt)("em",{parentName:"p"},"(or unique indexes)"),", and here, the ",(0,o.kt)("inlineCode",{parentName:"p"},"parent")," property of the root object being saved is null,\nand not all databases have the ability to define null behavior for unique constraints."),(0,o.kt)("p",{parentName:"li"},"Therefore, by default, if the ",(0,o.kt)("inlineCode",{parentName:"p"},"@Key")," property of the object being saved is null, Jimmer will give up using the database's own UPSERT capability,\nexecute an additional query to determine whether the subsequent operation should be ",(0,o.kt)("inlineCode",{parentName:"p"},"INSERT")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"UPDATE"),", and report ",(0,o.kt)("inlineCode",{parentName:"p"},"QueryReason.NULL_NOT_DISTINCT_REQUIRED")," to developers."),(0,o.kt)("admonition",{parentName:"li",type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Some databases, such as Postgres, can define null behavior for unique constraints.\nHow to solve this problem in such databases is not the focus of this article, please refer to the documentation comments of ",(0,o.kt)("inlineCode",{parentName:"p"},"QueryReason.NULL_NOT_DISTINCT_REQUIRED")," to learn more."))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Assuming the above query determines that the object being saved does not exist in the database, simply insert the root object:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"insert into TREE_NODE(NAME, PARENT_ID) \nvalues(?, ?)\n/* batch-0: [Root, DbNull{type=long}] */\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Save child objects ",(0,o.kt)("em",{parentName:"p"},"(assuming the id is known to be 100 after saving the root object)"),":"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"merge into TREE_NODE(\n    NAME, PARENT_ID\n) key(\n    NAME, PARENT_ID\n) values(?, ?)\n/* batch-0: [Child-1, 100] */\n/* batch-1: [Child-2, 100] */\n")))),(0,o.kt)("h2",{id:"2-configuring-whether-different-parent-objects-can-snatch-for-child-objects"},"2. Configuring Whether Different Parent Objects Can Snatch for Child Objects"),(0,o.kt)("h3",{id:"conservative-default-behavior"},"Conservative Default Behavior"),(0,o.kt)("p",null,"Let's look at an example first:"),(0,o.kt)(r.Z,{groupId:"language",mdxType:"Tabs"},(0,o.kt)(i.Z,{value:"java",label:"Java",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'BookStore store = Immutables.createBookStore(draft -> {\n    draft.setName("MANNING");\n    draft.addIntoBooks(book -> {\n        book.setId(12L);\n    });\n    draft.addIntoBooks(book -> {\n        book.setId(1L);\n    });\n});\nsqlClient.save(store);\n'))),(0,o.kt)(i.Z,{value:"kotlin",label:"Kotlin",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-kotlin"},'val store = BookStore {\n    name = "MANNING"\n    books().addBy {\n        id = 12L\n    }\n    books().addBy {\n        id = 1L\n    }\n}\nsqlClient.save(store)\n')))),(0,o.kt)("p",null,"Executing this code will generate the following SQL and result in an exception:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Saving the root object ",(0,o.kt)("inlineCode",{parentName:"p"},"BookStore"),":"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"merge into BOOK_STORE(\n    NAME\n) key(NAME) values(?)\n/* batch-0: [MANNING] */\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Saving the child objects ",(0,o.kt)("inlineCode",{parentName:"p"},"Book"),":"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"// highlight-next-line\nPurpose: COMMAND(TARGET_NOT_TRANSFERABLE)\nselect\n    tb_1_.ID,\n    tb_1_.NAME,\n    tb_1_.EDITION,\n    tb_1_.STORE_ID\nfrom BOOK tb_1_\nwhere\n    tb_1_.ID = any(? /* [12, 1] */)\n")),(0,o.kt)("p",{parentName:"li"},"Strangely, even though the id property of child objects is specified ",(0,o.kt)("em",{parentName:"p"},"(which usually means Jimmer will utilize the database's own ",(0,o.kt)("inlineCode",{parentName:"em"},"UPSERT")," capability)"),",\nJimmer still tries to determine whether the subsequent operation should be ",(0,o.kt)("inlineCode",{parentName:"p"},"INSERT")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"UPDATE")," through a query, rather than using the database's own ",(0,o.kt)("inlineCode",{parentName:"p"},"UPSERT")," capability.\nMore importantly, Jimmer reports ",(0,o.kt)("inlineCode",{parentName:"p"},"QueryReason.TARGET_NOT_TRANSFERABLE"),".")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Finally, the above code will result in the following exception:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-sh"},'Save error caused by the path: "<root>.books": \nCan the move the child object whose type is "org.doc.j.model.Book" \nand id is "1" to another parent object because the property \n"org.doc.j.model.BookStore.books" \n// highlight-next-line\ndoes not support target transfer\n')))),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"Book.store")," is a many-to-one association, a ",(0,o.kt)("inlineCode",{parentName:"p"},"Book")," object can only belong to one ",(0,o.kt)("inlineCode",{parentName:"p"},"BookStore")," object and cannot belong to multiple ",(0,o.kt)("inlineCode",{parentName:"p"},"BookStore")," objects simultaneously."),(0,o.kt)("p",null,"Therefore, saving the data structure through the inverse one-to-many association ",(0,o.kt)("inlineCode",{parentName:"p"},"BookStore.books")," establishes an association between the current ",(0,o.kt)("inlineCode",{parentName:"p"},"BookStore")," parent object and another existing ",(0,o.kt)("inlineCode",{parentName:"p"},"Book")," object.\nIf the ",(0,o.kt)("inlineCode",{parentName:"p"},"Book")," object already belongs to another parent object, it will cause the current parent object to snatch for the child object from other parent objects. In other words, the child object migrates between different parent objects."),(0,o.kt)("p",null,"If this is expected behavior by the developers, then there's no problem. However, if this is not expected behavior, it may lead to unintended oversights."),(0,o.kt)("p",null,"By default, Jimmer adopts a conservative strategy that prohibits child objects from transfering between different parent objects."),(0,o.kt)("p",null,"In this example, attempting to associate ",(0,o.kt)("inlineCode",{parentName:"p"},"BookStore(MANNING)")," with ",(0,o.kt)("inlineCode",{parentName:"p"},"Book(12)")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"Book(1)"),",\nJimmer executes an additional query with ",(0,o.kt)("inlineCode",{parentName:"p"},"QueryReason.TARGET_NOT_TRANSFERABLE")," to check if any child objects are transfering between different parent objects."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Book(12)")," already belongs to ",(0,o.kt)("inlineCode",{parentName:"li"},"BookStore(MANNING)"),", no transfer occurs, no problem"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Book(1)")," doesn't belong to ",(0,o.kt)("inlineCode",{parentName:"li"},"BookStore(MANNING)")," but belongs to ",(0,o.kt)("inlineCode",{parentName:"li"},"BookStore(O'REILLY)"),", transfer occurs, therefore an exception is thrown.")),(0,o.kt)("p",null,"The default behavior is very conservative. While it prevents competition for child objects between different parent objects ",(0,o.kt)("em",{parentName:"p"},"(if developers consider such unintended competition harmful to business)"),",\nit leads to additional queries and doesn't fully utilize the database's own ",(0,o.kt)("inlineCode",{parentName:"p"},"UPSERT")," capability, resulting in suboptimal performance."),(0,o.kt)("p",null,"If you believe better performance is more important than this conservative defensive behavior, Jimmer provides additional configuration to change this behavior."),(0,o.kt)("h3",{id:"overriding-default-behavior-without-restrictions"},"Overriding Default Behavior Without Restrictions"),(0,o.kt)("p",null,"To prioritize performance and remove these restrictions, there are two methods:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Save command level configuration, which can be divided into two types:"),(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Precise configuration, removing restrictions for specific associations:"),(0,o.kt)(r.Z,{groupId:"language",mdxType:"Tabs"},(0,o.kt)(i.Z,{value:"java",label:"Java",mdxType:"TabItem"},(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-java"},"BookStore store = ...omitted...;\nsqlClient\n    .saveCommand(store)\n    // highlight-next-line\n    .setTargetTransferMode(\n        BookStoreProps.BOOKS, \n        TargetTransferMode.ALLOWED\n    )\n    .execute();\n"))),(0,o.kt)(i.Z,{value:"kotlin",label:"Kotlin",mdxType:"TabItem"},(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-kotlin"},"val store = BookStore {...omitted...}\nsqlClient.save(store) {\n    // highlight-next-line\n    setTargetTransferMode(\n        BookStore::books, \n        TargetTransferMode.ALLOWED\n    )\n}\n"))))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Blind configuration, removing restrictions for all associations:"),(0,o.kt)(r.Z,{groupId:"language",mdxType:"Tabs"},(0,o.kt)(i.Z,{value:"java",label:"Java",mdxType:"TabItem"},(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-java"},"BookStore store = ...omitted...;\nsqlClient\n    .saveCommand(store)\n    // highlight-next-line\n    .setTargetTransferModeAll(\n        TargetTransferMode.ALLOWED\n    )\n    .execute();\n"))),(0,o.kt)(i.Z,{value:"kotlin",label:"Kotlin",mdxType:"TabItem"},(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-kotlin"},"val store = BookStore {...omitted...}\nsqlClient.save(store) {\n    // highlight-next-line\n    setTargetTransferModeAll(\n        TargetTransferMode.ALLOWED\n    )\n}\n")))))),(0,o.kt)("p",{parentName:"li"},"Whether precise or blind configuration, the last parameter is the ",(0,o.kt)("inlineCode",{parentName:"p"},"TargetTransferMode")," enum, which has three values:"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"ALLOWED"),": Allows child object transfer and tries to use the database's own ",(0,o.kt)("inlineCode",{parentName:"p"},"UPSERT")," capability whenever possible")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"NOT_ALLOWED"),": Prohibits child object transfer, initiates additional queries with ",(0,o.kt)("inlineCode",{parentName:"p"},"QueryReason.TARGET_NOT_TRANSFERABLE")," for verification.\nIf child object transfer occurs, throws an exception")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"AUTO")," (default): Current configuration is invalid, refers to lower priority configuration"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"For precise configuration, refers to blind configuration")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"For blind configuration, refers to global configuration")))))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Global configuration, which can be divided into two types:"),(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Global configuration based on Jimmer API:"),(0,o.kt)(r.Z,{groupId:"language",mdxType:"Tabs"},(0,o.kt)(i.Z,{value:"java",label:"Java",mdxType:"TabItem"},(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-java"},"JSqlClient sqlCient = JSqlClient\n    .newBuilder()\n    // highlight-next-line\n    .setTargetTransferable(true)\n    ...other configurations omitted...\n    .build();\n"))),(0,o.kt)(i.Z,{value:"kotlin",label:"Kotlin",mdxType:"TabItem"},(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-kotlin"},"val sqlClient = sqlClient {\n    // highlight-next-line\n    setTargetTransferable(true)\n    ...other configurations omitted...\n}\n"))))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Global configuration based on Spring Boot if using Jimmer's spring-boot-starter:"),(0,o.kt)("p",{parentName:"li"},"Using ",(0,o.kt)("inlineCode",{parentName:"p"},"application.yml")," as an example:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-sh",metastring:'title = "application.yml"',title:!0,"":"",'"application.yml"':!0},"jimmer:\n    // highlight-next-line\n    target-transferable: true\n    ...other configurations omitted...\n")))))),(0,o.kt)("p",null,"Once Jimmer is configured through any of the above methods to not restrict child object transfer for the ",(0,o.kt)("inlineCode",{parentName:"p"},"BookStore.books")," association, modify the code as follows:"),(0,o.kt)(r.Z,{groupId:"language",mdxType:"Tabs"},(0,o.kt)(i.Z,{value:"java",label:"Java",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java",metastring:'title="Book.java"',title:'"Book.java"'},"public interface Book {\n\n    @ManyToOne\n    @Nullable\n    // Not related to the current discussion, \n    // please ignore for now\n    // highlight-next-line\n    @OnDissociate(DissociateAction.SET_NULL)\n    BookStore store();\n\n    ...other code omitted...\n}\n"))),(0,o.kt)(i.Z,{value:"kotlin",label:"Kotlin",mdxType:"TabItem"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-kotlin",metastring:'title="Book.kt"',title:'"Book.kt"'},"public interface Book {\n\n    @ManyToOne\n    // Not related to the current discussion, \n    // please ignore for now\n    // highlight-next-line\n    @OnDissociate(DissociateAction.SET_NULL)\n    val store: BookStore?\n\n    ...other code omitted...\n}\n")))),(0,o.kt)("p",null,"Re-executing the code will generate the following SQL:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Saving the root object:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"merge into BOOK_STORE(\n    NAME\n) key(NAME) values(?)\n/* batch-0: [MANNING] */\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Establishing associations between root object and child objects:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"merge into BOOK(\n    ID, STORE_ID\n) key(ID) values(?, ?)\n/* batch-0: [12, 2] */\n/* batch-1: [1, 2] */\n"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Breaking associations between root object and no longer needed child objects:"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"update BOOK\nset\n    STORE_ID = null\nwhere\n    STORE_ID = ?\n    and\n    not (\n        ID = any(?)\n    )\n/* batch-0: [2, [12, 1]] */\n")))),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"To demonstrate performance-priority scenarios to users, the examples\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/babyfish-ct/jimmer-examples/tree/main/java/save-command"},"jimmer-examples/java/save-command"),"\nand\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/babyfish-ct/jimmer-examples/tree/main/kotlin/save-command-kt"},"jimmer-examples/kotlin/save-command-kt"),"\nboth use global configuration to allow child object transfer.")))}u.isMDXComponent=!0}}]);